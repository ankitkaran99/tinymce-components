<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TinyMCE Components Manager</title>

    <!-- TinyMCE -->
    <script
      src="https://cdn.tiny.cloud/1/8vvkv6w43bqshhdlpqsukby74l3pg2z7mlr0zr6rozvw2vgu/tinymce/7/tinymce.min.js"
      referrerpolicy="origin"
    ></script>
    
    <!-- Component Manager CSS -->
    <link rel="stylesheet" href="component-manager.css">
    
    <!-- Component Manager JS -->
    <script src="component.js"></script>
    <script src="component-manager.js"></script>
    
    <!-- Bootstrap 5 Components JS -->
    <script src="bootstrap5-components.js"></script>
  </head>
  <body>
    <div style="display: flex; height: 100vh; overflow-y: auto;">
      <!-- Components Panel -->
      <div id="sidebar1" style="width: 350px; height: 100%;">
        <div class="panel-header">Components</div>
        <div class="components-scrollable"></div>
      </div>
      
      <div style="width: 100%; height: 100%;">
        <textarea id="editor">
          <h2>Welcome to TinyMCE with Components Manager!</h2>
          <p>Drag components from the left panel into the editor. Select any element to edit its properties on the right.</p>
        </textarea>
      </div>
      
      <!-- Properties Panel -->
      <div id="sidebar2" style="width: 350px; height: 100%;">
        <div class="panel-header">Properties</div>
        <div class="properties-scrollable"></div>
      </div>
    </div>

    <script>
      // Initialize TinyMCE with the components manager
      document.addEventListener("DOMContentLoaded", () => {
        const editor = tinymce.init({
          selector: "#editor",
          plugins: 'advlist autolink lists link image charmap preview anchor pagebreak searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking save table directionality emoticons importcss codesample autoresize',
          toolbar: 'undo redo | styleselect | bold italic forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media | print preview code | formatselect | blockquote hr | removeformat | subscript superscript | charmap | ltr rtl | visualblocks visualchars | code fullscreen | insertdatetime media table | toc | autoresize',
          height: '100%',
          content_css: [
            'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css',
          ],
          // Allow all elements and attributes
          valid_elements: '*[*]',
          // Allow any child elements in these containers
          valid_children: '+body[style],+div[div|ul|ol|li],+ul[li],+ol[li],+li[div|ul|ol|li]',
          // Explicitly allow all data attributes
          extended_valid_elements: '*[*]',
          // Configure TinyMCE to preserve our component attributes
          valid_attributes: 'id,class,style,data-*',
          // Disable cleanup to prevent attribute removal
          verify_html: false,
          cleanup: false,
          cleanup_on_startup: false,
          trim_span_elements: false,
          // donâ€™t carry over inline styles
          keep_styles: false,
          // Preserve data attributes on paste and other operations
          paste_data_images: false,
          paste_webkit_styles: 'all',
          paste_merge_formats: true,
          paste_auto_cleanup_on_paste: false,
          paste_remove_styles: false,
          paste_remove_styles_if_webkit: false,
          paste_strip_class_attributes: 'none',
          setup: function(editor) {
            editor.on('init', function(e) {
              // Add Bootstrap JS to the iframe
              const iframe = e.target.contentAreaContainer.querySelector('iframe');
              const iframeDoc = iframe.contentDocument;
              const script = iframeDoc.createElement('script');
              script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js';
              iframeDoc.head.appendChild(script);
              
              const componentsManager = ComponentsManager.setup(editor, "#sidebar1", "#sidebar2");
              cm_essentials_init(componentsManager);
              bs5_components_init(componentsManager);

              componentsManager.addStyle('Primary Button', {
                'background-color': '#4a6cf7',
                'color': 'white',
                'border': 'none',
                'padding': '8px 16px',
                'border-radius': '4px'
              });

              fetch('/docx_parser/output/ai_processed.html').then(response => response.text()).then(html => {
                const editor = tinymce.get('editor');
                editor.setContent(html);
              });
            });
          }
        });
      });
    </script>
  </body>
</html>
